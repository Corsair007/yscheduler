#!/bin/bash
usage(){
    echo "  Usage:"
    echo "     use '$0 dev/qa web/agent/both'."
    exit 1
}

ENV=$1
MODULE=$2
cd `dirname "$0"`
PRGDIR=`pwd`

if [ "$ENV" = "qa" -a "$ENV" = "dev" ]; then
  echo "Your input is not corrent!"
  usage
  exit 1
fi
if [ "$MODULE" != "web" -a "$MODULE" != "agent" -a "$MODULE" != "both" ]; then
  echo "Your input is not corrent!"
  usage
  exit 1
fi

#svn co
cd /tmp
rm -rf yscheduler
svn co svn://svn.dy/platform/yscheduler/branches/develop yscheduler
cd yscheduler

#maven 
MVN_PROFILE=""
if [ "$ENV" = "qa" ]; then
  MVN_PROFILE="-P${ENV}"
fi
mvn clean package -DskipTests $MVN_PROFILE

AGENT_HOST="172.20.0.160"
WEB_HOST="172.20.0.135"
USER="ops"
PASSWORD="ops@123"
DATE=$(date +%Y%m%d_%H%M%S)

if [ "$ENV" == "dev" ]; then
  AGENT_HOST="172.20.0.101"
  WEB_HOST="172.20.0.100"
fi

cd $PRGDIR
if [ "$MODULE" == "web" ]; then
  echo "=============== deploying web to $WEB_HOST ============="
  ./deploy-web.sh $WEB_HOST $USER $PASSWORD $DATE
elif [ "$MODULE" == "agent" ]; then
  echo "=============== deploying agent to $AGENT_HOST ============="
  ./deploy-agent.sh $AGENT_HOST $USER $PASSWORD $DATE
else
  echo "=============== deploying web to $WEB_HOST ============="
  ./deploy-web.sh $WEB_HOST $USER $PASSWORD $DATE
  echo "=============== deploying agent to $AGENT_HOST ============="
  ./deploy-agent.sh $AGENT_HOST $USER $PASSWORD $DATE
fi
#go back
cd $PRGDIR
