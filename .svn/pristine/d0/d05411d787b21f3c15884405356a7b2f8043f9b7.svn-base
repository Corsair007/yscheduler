package com.yeahmobi.yscheduler.notice;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import org.apache.commons.httpclient.HttpClient;
import org.apache.commons.httpclient.NameValuePair;
import org.apache.commons.httpclient.methods.PostMethod;
import org.apache.commons.httpclient.params.HttpMethodParams;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.stereotype.Service;

/**
 * @author Ryan Sun
 */
@Service
public class DefaultSmsSender implements SmsSender {

    private static final Log    LOGGER   = LogFactory.getLog(DefaultSmsSender.class);

    private static final String DEV_MODE = "yscheduler.devMode";

    private boolean             devMode  = true;

    private String              smsApi;

    private String              app;

    private String              appKey;

    public String getSmsApi() {
        return this.smsApi;
    }

    public void setSmsApi(String smsApi) {
        this.smsApi = smsApi;
    }

    public String getApp() {
        return this.app;
    }

    public void setApp(String app) {
        this.app = app;
    }

    public String getAppKey() {
        return this.appKey;
    }

    public void setAppKey(String appKey) {
        this.appKey = appKey;
    }

    public DefaultSmsSender() {
        String devModeStr = System.getProperty(DEV_MODE, "true");
        if ("false".equals(devModeStr)) {
            this.devMode = false;
        }
    }

    public boolean send(Message message) {
        if (this.devMode) {
            LOGGER.info("Send message:" + message);
            return true;
        }
        try {
            HttpClient client = new HttpClient();
            PostMethod postMethod = new PostMethod(this.smsApi);
            NameValuePair[] parameters = new NameValuePair[6];
            for (String phoneNumber : message.getTo()) {
                String time = String.valueOf(new Date().getTime() / 1000);
                String sign = MD5Util.MD5(this.app + this.appKey + time).substring(0, 8).toLowerCase();
                parameters[0] = new NameValuePair("to", phoneNumber);
                parameters[1] = new NameValuePair("text", message.getSubject());
                parameters[2] = new NameValuePair("ip", "10.23.123.1");
                parameters[3] = new NameValuePair("_app", "yscheduler");
                parameters[4] = new NameValuePair("_time", time);
                parameters[5] = new NameValuePair("_sign", sign);
                System.out.println(parameters);
                postMethod.addParameters(parameters);
                postMethod.getParams().setParameter(HttpMethodParams.HTTP_CONTENT_CHARSET, "utf-8");

                client.executeMethod(postMethod);

                String response = postMethod.getResponseBodyAsString();
                System.out.println(response);

                if (!response.contains("\"code\":0")) {
                    return false;
                }
            }
            return true;

        } catch (Exception e) {
            LOGGER.error(e, e);
            return false;
        }
    }

    public static void main(String[] args) {
        DefaultSmsSender sender = new DefaultSmsSender();
        Message msg = new Message();
        List<String> to = new ArrayList<String>();
        to.add("15021290572");
        msg.setContent("你好，快枪手");
        msg.setTo(to);
        sender.send(msg);
    }
}
