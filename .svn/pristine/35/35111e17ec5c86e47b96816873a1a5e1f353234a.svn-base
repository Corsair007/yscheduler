(function(w) {
	var app = {
		"changeType" : function(select) {
			var value = $(select).val();
			console.log(value);
			if (value == 20) {// shell
				$("div[httpCallout]").show();
				$("div[agent]").hide();
				$("div[command]").hide();
			} else {
				$("div[httpCallout]").hide();
				$("div[agent]").show();
				$("div[command]").show();
			}
		},
		"openTriggerTaskModal" : function(triggerTaskId) {
			$('#triggerTaskModal input[taskId]').val(triggerTaskId);
			$('#triggerTaskModal').modal('show');
		},
		"triggerTask" : function(form) {
			var triggerTaskId = $('#triggerTaskModal input[taskId]').val();
			$("#triggerTaskModal div[alertMessage]").text('');
			$.ajax({
				type : $(form).attr('method'),
				url : $(form).attr('action'),
				data : $(form).serialize(),
				dataType : "json",
				success : app.triggerTaskDone(triggerTaskId),
				error : app.httpError
			});
			return false;
		},
		"triggerTaskDone" : function(triggerTaskId) {
			return function(data) {
				if (data.success == false) {
					$("#triggerTaskModal div[alertMessage]").html(
							$("#alert_error").html());
					$("#triggerTaskModal div[alertMessage] > div > span").text(
							data.errorMsg);
				} else {
					w.location = w.contextPath + "/task/instance?taskId="
							+ triggerTaskId;
				}
			}
		},
		"openTriggerWorkflowInstanceCancelModal" : function(workflowInstanceId) {
			$(
					'#openTriggerWorkflowInstanceCancelModal input[workflowInstanceId]')
					.val(workflowInstanceId);
			$('#openTriggerWorkflowInstanceCancelModal').modal('show');
		},
		"cancelWorkflowInstance" : function(form) {
			var workflowInstanceId = $(
					'#openTriggerWorkflowInstanceCancelModal input[workflowInstanceId]')
					.val();
			$("#openTriggerWorkflowInstanceCancelModal div[alertMessage]")
					.text('');
			$.ajax({
				type : $(form).attr('method'),
				url : $(form).attr('action'),
				data : $(form).serialize(),
				dataType : "json",
				success : app.cancelWorkflowInstanceDone(workflowInstanceId),
				error : app.httpError
			});
			return false;
		},
		"cancelWorkflowInstanceDone" : function(workflowInstanceId) {
			return function(data) {
				if (data.success == false) {
					$(
							"#openTriggerWorkflowInstanceCancelModal div[alertMessage]")
							.html($("#alert_error").html());
					$(
							"#openTriggerWorkflowInstanceCancelModal div[alertMessage] > div > span")
							.text(data.errorMsg);
				} else {
					w.location.reload();
				}
			}
		},
		"openCancelTaskModal" : function(instanceId) {
			$('#cancelTaskModal input[instanceId]').val(instanceId);
			$('#cancelTaskModal').modal('show');
		},
		"cancelTask" : function(form) {
			var instanceId = $('#cancelTaskModal input[instanceId]').val();
			$("#cancelTaskModal div[alertMessage]").text('');
			$.ajax({
				type : $(form).attr('method'),
				url : $(form).attr('action'),
				data : $(form).serialize(),
				dataType : "json",
				success : app.cancelTaskDone(instanceId),
				error : app.httpError
			});
			return false;
		},
		"cancelTaskDone" : function(taskId) {
			return function(data) {
				if (data.success == false) {
					$("#cancelTaskModal div[alertMessage]").html(
							$("#alert_error").html());
					$("#cancelTaskModal div[alertMessage] > div > span").text(
							data.errorMsg);
				} else {
					$('#cancelTaskModal').modal('hide');
					w.location.reload();
				}
			}
		},
		"openCreateUserModal" : function() {
			$('#createUserModal').modal('show');
			$("#createUserModal input[name='username']").focus();
		},
		"createUser" : function(form) {
			$("#createUserModal div[alertMessage]").text('');
			$.ajax({
				type : $(form).attr('method'),
				url : $(form).attr('action'),
				data : $(form).serialize(),
				dataType : "json",
				success : app.createUserDone,
				error : app.httpError
			});
			return false;
		},
		"createUserDone" : function(data) {
			if (data.success == false) {
				$("#createUserModal div[alertMessage]").html(
						$("#alert_error").html());
				$("#createUserModal div[alertMessage] > div > span").text(
						data.errorMsg);
			} else {
				w.location = w.contextPath + "/user";
			}
		},
		"openRemoveUserModal" : function(removeUserId, removeUserName) {
			$('#removeUserModal input[userId]').val(removeUserId);
			$('#removeUserModal span[username]').text(removeUserName);
			$('#removeUserModal').modal('show');
		},
		"removeUser" : function(form) {
			var removeUserId = $('#removeUserModal input[userId]').val();
			$("#removeUserModal div[alertMessage]").text('');
			$.ajax({
				type : $(form).attr('method'),
				url : $(form).attr('action'),
				data : $(form).serialize(),
				dataType : "json",
				success : app.removeUserDone(removeUserId),
				error : app.httpError
			});
			return false;
		},
		"removeUserDone" : function(removeUserId) {
			return function(data) {
				if (data.success == false) {
					$("#removeUserModal div[alertMessage]").html(
							$("#alert_error").html());
					$("#removeUserModal div[alertMessage] > div > span").text(
							data.errorMsg);
				} else {
					w.location = w.contextPath + "/user";
				}
			}
		},
		"openResetPasswordModal" : function(userId, username) {
			$('#resetPasswordModal input[userId]').val(userId);
			$('#resetPasswordModal span[username]').text(username);
			$('#resetPasswordModal').modal('show');
		},
		"resetPassword" : function(form) {
			var userId = $('#resetPasswordModal input[userId]').val();
			$("#resetPasswordModal div[alertMessage]").text('');
			$.ajax({
				type : $(form).attr('method'),
				url : $(form).attr('action'),
				data : $(form).serialize(),
				dataType : "json",
				success : app.resetPasswordDone(userId),
				error : app.httpError
			});
			return false;
		},
		"resetPasswordDone" : function(userId) {
			return function(data) {
				if (data.success == false) {
					$("#resetPasswordModal div[alertMessage]").html(
							$("#alert_error").html());
					$("#resetPasswordModal div[alertMessage] > div > span")
							.text(data.errorMsg);
				} else {
					app.alertSuccess("重置成功");
					$('#resetPasswordModal').modal('hide');
					// w.location = w.contextPath + "/user";
				}
			}
		},
		"openInstanceLogModal" : function(attemptId) {
			app.getAttemptLogTask(attemptId);
			$('#instanceLogModal').modal('show');
		},
		"getAttemptLogTask" : function(attemptId) {
			var param = new Object();
			param.attemptId = attemptId;
			$.ajax({
				type : "get",
				url : w.contextPath + "/task/instance/attempt/getLog",
				data : param,
				dataType : "json",
				success : app.getAttemptLogTaskDone(attemptId),
				error : app.httpError
			});
		},
		"getAttemptLogTaskDone" : function(attemptId) {
			return function(data) {
				if (data.success == false) {
					$("#instanceLogModal div[alertMessage]").html(
							$("#alert_error").html());
					$("#instanceLogModal div[alertMessage] > div > span").text(
							data.errorMsg);
				} else {
					$("#instanceLogModal pre[log]").text(data.log);
					// app.getAttemptLogTask(attemptId);
				}
			}
		},
		// //////////////////////////////////////////////////////////////////
		"openCreateAgentModal" : function() {
			$('#createAgentModal').modal('show');
			$("#createAgentModal input[name='name']").focus();
		},
		"createAgent" : function(form) {
			$("#createAgentModal div[alertMessage]").text('');
			$.ajax({
				type : $(form).attr('method'),
				url : $(form).attr('action'),
				data : $(form).serialize(),
				dataType : "json",
				success : app.createAgentDone,
				error : app.httpError
			});
			return false;
		},
		"createAgentDone" : function(data) {
			if (data.success == false) {
				$("#createAgentModal div[alertMessage]").html(
						$("#alert_error").html());
				$("#createAgentModal div[alertMessage] > div > span").text(
						data.errorMsg);
			} else {
				w.location = w.contextPath + "/agent";
			}
		},
		"openRemoveAgentModal" : function(agentId, agentName) {
			$('#removeAgentModal input[agentId]').val(agentId);
			$('#removeAgentModal span[agentName]').text(agentName);
			$('#removeAgentModal input[agentName]').val(agentName);
			$('#removeAgentModal').modal('show');
		},
		"removeAgent" : function(form) {
			var agentId = $('#removeAgentModal input[agentId]').val();
			$("#removeAgentModal div[alertMessage]").text('');
			$.ajax({
				type : $(form).attr('method'),
				url : $(form).attr('action'),
				data : $(form).serialize(),
				dataType : "json",
				success : app.removeAgentDone(agentId),
				error : app.httpError
			});
			return false;
		},
		"removeAgentDone" : function(agentId) {
			return function(data) {
				if (data.success == false) {
					$("#removeAgentModal div[alertMessage]").html(
							$("#alert_error").html());
					$("#removeAgentModal div[alertMessage] > div > span").text(
							data.errorMsg);
				} else {
					w.location = w.contextPath + "/agent";
				}
			}
		},
		"openUpdateAgentIpModal" : function(agentId, agentName) {
			$('#updateAgentIpModal input[agentId]').val(agentId);
			$('#updateAgentIpModal span[agentName]').text(agentName);
			$('#updateAgentIpModal input[agentName]').val(agentName);
			$('#updateAgentIpModal').modal('show');
		},
		"updateAgentIp" : function(form) {
			var agentId = $('#updateAgentIpModal input[agentId]').val();
			$("#updateAgentIpModal div[alertMessage]").text('');
			$.ajax({
				type : $(form).attr('method'),
				url : $(form).attr('action'),
				data : $(form).serialize(),
				dataType : "json",
				success : app.updateAgentIpDone(agentId),
				error : app.httpError
			});
			return false;
		},
		"updateAgentIpDone" : function(agentId) {
			return function(data) {
				if (data.success == false) {
					$("#updateAgentIpModal div[alertMessage]").html(
							$("#alert_error").html());
					$("#updateAgentIpModal div[alertMessage] > div > span")
							.text(data.errorMsg);
				} else {
					w.location = w.contextPath + "/agent";
				}
			}
		},
		// //////////////////////////////////////////////////////////////////
		"isEmail" : function(email) {
			var regex = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
			return regex.test(email);
		},
		"refresh" : function() {
			w.location.reload();
		},
		"alertProgress" : function(divId) {
			if (!divId) {
				divId = "alertMessageDiv";
			}
			$("#" + divId).html($("#progress").html());
		},
		"clearAlertMessage" : function(divId) {
			if (!divId) {
				divId = "alertMessageDiv";
			}
			$("#" + divId).html('');
		},
		"alertError" : function(msg, divId) {
			if (!divId) {
				divId = "alertMessageDiv";
			}
			console.log("alert error:" + msg);
			$("#" + divId).html($("#alert_error").html());
			$("#" + divId + " > div > span").text(msg);
		},
		"alertSuccess" : function(msg, divId) {
			// $("#alertMessageDiv").html($("#alert_success").html());
			// $("#alertMessageDiv > div > span > span").text(msg);
			if (!divId) {
				divId = "alertMessageDiv";
			}
			$("#" + divId).html($("#alert_success").html());
			$("#" + divId + " > div > span").text(msg);
		},
		"alertWarn" : function(msg, divId) {
			// $("#alertMessageDiv").html($("#alert_warn").html());
			// $("#alertMessageDiv > div > span > span").text(msg);
			if (!divId) {
				divId = "alertMessageDiv";
			}
			$("#" + divId).html($("#alert_warn").html());
			$("#" + divId + " > div > span").text(msg);
		},
		"appError" : function(title, errorMsg) {
			app.alertErrorModal(title, errorMsg);
		},
		"httpError" : function(xhr, textStatus, errorThrown) {
			app.alertErrorModal('抱歉啦，亲', '抱歉，网络发生错误了，请刷新页面试试...');
		},
		"alertErrorModal" : function(title, errorMsg) {
			// 显示错误消息
			$('#errorMsg h4[title]').text(title);
			$('#errorMsg span[alertMessage]').text(errorMsg);
			$('#errorMsg').modal('show');
		},
		"endWith" : function(s, endStr) {
			if (s == null || s == "" || s.length == 0
					|| endStr.length > s.length)
				return false;
			if (s.substring(s.length - endStr.length) == endStr)
				return true;
			else
				return false;
			return true;
		},
		"startWith" : function(s, preStr) {
			if (s == null || s == "" || s.length == 0
					|| preStr.length > s.length)
				return false;
			if (s.substr(0, preStr.length) == preStr)
				return true;
			else
				return false;
			return true;
		},
		"refresh" : function() {
			w.location.reload();
		},
		"bookmarkPage" : function(url, title) {
			try {
				if (!url) {
					url = window.location
				}
				if (!title) {
					title = document.title
				}
				var browser = navigator.userAgent.toLowerCase();
				if (window.sidebar) { // Mozilla, Firefox, Netscape
					window.sidebar.addPanel(title, url, "");
				} else if (window.external) { // IE or chrome
					if (browser.indexOf('chrome') == -1) { // ie
						window.external.AddFavorite(url, title);
					} else { // chrome
						alert('请按 Ctrl和D 快捷键进行收藏');
					}
				} else if (window.opera && window.print) { // Opera -
					// automatically
					// adds to sidebar if
					// rel=sidebar in the tag
					return true;
				} else if (browser.indexOf('konqueror') != -1) { // Konqueror
					alert('请按 Ctrl和B 快捷键进行收藏');
				} else if (browser.indexOf('webkit') != -1) { // safari
					alert('请按 Ctrl和B 快捷键进行收藏');
				} else {
					alert('您的浏览器不支持该操作，请您点击浏览器的“收藏”菜单进行添加。');
				}
			} catch (err) {
				alert('您的浏览器不支持该操作，请您点击浏览器的“收藏”菜单进行添加。');
			}
		},
		"onHashChange" : function() {
			var hash = window.location.hash;
			if (hash.length > 0) {
				// 去掉#号
				hash = hash.substring(1);
				var j, r;
				$.each(hash.split('&'), function(i, part) {
					var keyValue = part.split('=');
					if (keyValue[0] == 'j') {
						j = keyValue[1];
						rundemo_app.changeJavaCodeFile(keyValue[1]);
					} else if (keyValue[0] == 'r') {
						r = keyValue[1];
						rundemo_app.changeResourceFile(keyValue[1]);
					}
				});
				if (j == 0 && r == 0) {
					window.location.hash = "";
				}
			} else {
				rundemo_app.changeJavaCodeFile(0);
				rundemo_app.changeResourceFile(0);
			}
		},

		"onCrontabTip" : function() {
			var crontabs = {
				"每分钟" : "* * * * *",
				"每十分钟" : "*/10 * * * *",
				"每小时" : "0 * * * *",
				"每天零点" : "0 0 * * *",
				"每周一" : "0 0 * * 2",
				"每月一号" : "0 0 1 * *"
			};
			for ( var key in crontabs) {
				$('#crontab_div').append(
						'[<a onclick = "$(\'#crontab\').val(\'' + crontabs[key]
								+ '\')">' + key + '</a>]&nbsp');
			}
		}
	};
	w.app = app;
}(window || this));

$(document).ready(function() {
	$('a[data-toggle=tooltip]').tooltip();

});

/** 长度超过多少就截断，并加省略号 */
String.prototype.trunc = String.prototype.trunc || function(n) {
	return this.length > n ? this.substr(0, n - 3) + '...' : this;
};
