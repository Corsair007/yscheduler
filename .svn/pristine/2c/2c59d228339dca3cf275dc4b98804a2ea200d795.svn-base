package com.yeahmobi.yscheduler.web.filter;

import java.io.IOException;
import java.net.URLEncoder;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang.StringUtils;
import org.springframework.web.context.support.WebApplicationContextUtils;

import com.yeahmobi.yscheduler.model.common.UserContext;
import com.yeahmobi.yscheduler.model.common.UserContextHolder;
import com.yeahmobi.yscheduler.model.service.UserService;
import com.yeahmobi.yscheduler.web.common.UserContextUtils;

/**
 * @author Leo.Liang
 */
public class UserContextFilter implements Filter {

    private static final String LOGIN_URL        = "/login";
    private static final String STATIC_URL       = "/static/";
    private static final String ASSETS_URL       = "/assets/";
    private static final String API_URL          = "/api/";

    private static final String PARAM_RETURN_URL = "returnUrl";

    private UserService         userService;

    public void init(FilterConfig filterConfig) throws ServletException {
        this.userService = WebApplicationContextUtils.getWebApplicationContext(filterConfig.getServletContext()).getBean(UserService.class);
    }

    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException,
                                                                                             ServletException {
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        String servletPath = httpRequest.getServletPath();
        UserContext userContext = UserContextUtils.getContext(httpRequest, this.userService);
        if (!LOGIN_URL.equalsIgnoreCase(servletPath) && !servletPath.startsWith(STATIC_URL)
            && !servletPath.startsWith(ASSETS_URL) && !servletPath.startsWith(API_URL)) {
            if (userContext == null) {
                String returnUrl = servletPath;
                String queryString = httpRequest.getQueryString();
                if (StringUtils.isNotBlank(queryString)) {
                    returnUrl = returnUrl + "?" + queryString;
                }

                returnUrl = URLEncoder.encode(returnUrl, "UTF-8");

                ((HttpServletResponse) response).sendRedirect(httpRequest.getContextPath() + LOGIN_URL + "?"
                                                              + PARAM_RETURN_URL + "=" + returnUrl);
            } else {
                try {
                    UserContextHolder.setUserContext(userContext);
                    chain.doFilter(request, response);
                } finally {
                    UserContextHolder.clear();
                }
            }
        } else {
            if (LOGIN_URL.equalsIgnoreCase(servletPath) && (userContext != null)) {
                try {
                    UserContextHolder.setUserContext(userContext);
                    ((HttpServletResponse) response).sendRedirect(httpRequest.getContextPath() + "/");
                } finally {
                    UserContextHolder.clear();
                }
            } else {
                chain.doFilter(httpRequest, response);
            }
        }
    }

    public void destroy() {
        // do nothing
    }

}
