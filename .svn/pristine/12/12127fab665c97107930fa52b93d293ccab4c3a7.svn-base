package com.yeahmobi.yscheduler.workflow;

import java.util.ArrayList;
import java.util.List;

import javax.annotation.PostConstruct;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.yeahmobi.yscheduler.model.TaskInstance;
import com.yeahmobi.yscheduler.model.WorkflowDetail;
import com.yeahmobi.yscheduler.model.WorkflowInstance;
import com.yeahmobi.yscheduler.model.service.TaskInstanceService;
import com.yeahmobi.yscheduler.model.service.WorkflowDetailService;
import com.yeahmobi.yscheduler.model.service.WorkflowInstanceService;
import com.yeahmobi.yscheduler.model.type.TaskInstanceStatus;

/**
 * @author Ryan Sun
 */
@Service
public class DefaultWorkflowExecutor implements WorkflowExecutor {

    @Autowired
    private WorkflowDetailService   workflowDetailService;

    @Autowired
    private WorkflowInstanceService workflowInstanceService;

    @Autowired
    private TaskInstanceService     taskInstanceService;

    @Autowired
    private WorkflowEngine          workflowEngine;

    @PostConstruct
    public void init() {
        List<WorkflowInstance> instances = this.workflowInstanceService.getAllInits();
        for (WorkflowInstance instance : instances) {
            submit(instance);
        }
    }

    public void submit(WorkflowInstance workflowInstance) {

        long workflowId = workflowInstance.getWorkflowId();
        long instanceId = workflowInstance.getId();
        this.taskInstanceService.deleteByWorkflowInstanceId(instanceId);
        List<WorkflowDetail> details = this.workflowDetailService.list(workflowId);
        List<TaskInstance> taskIntances = new ArrayList<TaskInstance>();
        for (WorkflowDetail detail : details) {
            long taskId = detail.getTaskId();
            TaskInstance instance = new TaskInstance();
            instance.setTaskId(taskId);
            instance.setWorkflowInstanceId(instanceId);
            instance.setStatus(TaskInstanceStatus.DEPENDENCY_WAIT);
            this.taskInstanceService.save(instance);
            taskIntances.add(instance);
        }
        this.workflowEngine.submit(workflowInstance, taskIntances);

    }

}
