package com.yeahmobi.yscheduler.web.controller;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.IOException;
import java.io.UnsupportedEncodingException;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang.StringUtils;
import org.apache.commons.lang.Validate;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.ServletRequestUtils;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;

import com.yeahmobi.yscheduler.fileservice.FileEntry;
import com.yeahmobi.yscheduler.fileservice.FileKey;
import com.yeahmobi.yscheduler.fileservice.FileService;

/**
 * @author Abel.Cui
 * @date 2015/3/10
 */
@Controller
@RequestMapping(value = { FileOperateController.SCREEN_NAME })
public class FileOperateController {

    public static final String  SCREEN_NAME = "fileOperate";

    private static final Logger LOGGER      = LoggerFactory.getLogger(FileOperateController.class);

    @Autowired
    private FileService         fileService;

    /**
     * 上传文件
     *
     * @author Abel.Cui
     * @date 2015/3/10
     * @param request
     * @param fileUpload
     * @return JSON字符串,格式为：{"data":{"version":3},"success":true}或{"errmsg":"info...","success":false}
     */
    @RequestMapping(value = "upload")
    public String upload(HttpServletRequest request, @RequestParam("fileUpload") MultipartFile fileUpload) {

        ActionResult result = new ActionResult();
        try {
            String nameSpace = ServletRequestUtils.getStringParameter(request, "nameSpace");
            String key = ServletRequestUtils.getStringParameter(request, "fileName");
            Validate.notEmpty(nameSpace, "命名空间不可为空！");
            Validate.notEmpty(key, "文件名不可为空！");
            long version = this.fileService.store(new FileKey(nameSpace, key),
                                                  new FileEntry(fileUpload.getOriginalFilename(),
                                                                fileUpload.getInputStream()));
            result.success(version);
        } catch (Exception e) {
            result.fail(e.getMessage());
            LOGGER.error(e.getMessage(), e);
        }
        return result.toJSONString();
    }

    /**
     * 下载
     */
    @RequestMapping(value = "download")
    public void download(HttpServletRequest request, HttpServletResponse response) {

        try {
            String nameSpace = ServletRequestUtils.getStringParameter(request, "nameSpace");
            String key = ServletRequestUtils.getStringParameter(request, "fileName");
            String version = ServletRequestUtils.getStringParameter(request, "version");
            Validate.notEmpty(nameSpace, "命名空间不可为空！");
            Validate.notEmpty(key, "文件名不可为空！");
            if (StringUtils.isBlank(version)) {
                version = "0";
            }
            FileEntry fileEntry = this.fileService.get(new FileKey(nameSpace, key), Long.valueOf(version));
            downloadFile(request, response, fileEntry);
        } catch (Exception e) {
            LOGGER.error(e.getMessage(), e);
        }
    }

    private void downloadFile(HttpServletRequest request, HttpServletResponse response, FileEntry fileEntry)
                                                                                                            throws UnsupportedEncodingException,
                                                                                                            IOException {
        request.setCharacterEncoding("UTF-8");
        response.setContentType("text/html;charset=UTF-8");
        response.setContentType("application/octet-stream");
        response.setHeader("Content-disposition", "attachment; filename="
                                                  + new String(fileEntry.getFileName().getBytes("utf-8"), "ISO8859-1"));
        response.setHeader("Content-Length", String.valueOf(fileEntry.getInputStream().available()));

        BufferedInputStream bis = null;
        BufferedOutputStream bos = null;
        bis = new BufferedInputStream(fileEntry.getInputStream());
        bos = new BufferedOutputStream(response.getOutputStream());
        byte[] buff = new byte[2048];
        int bytesRead;
        while (-1 != (bytesRead = bis.read(buff, 0, buff.length))) {
            bos.write(buff, 0, bytesRead);
        }
        bis.close();
        bos.close();
    }

}
